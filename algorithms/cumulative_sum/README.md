# 2次元累積和

- 初期化時に、すべての座標について、原点と当該座標がなす長方形に含まれる数値の和を計算しておく。
  - 1列ずつ、もしくは1行ずつスキャンすることで、それまでの累積和を利用して計算できる。
    - `(当該座標の値) + (左の長方形) + (上の長方形) - (左上の長方形)` で求められる。
  - 1マスあたり`O(1)` で求められるため、初期化の計算量は `O(HW)` 。
- 任意の長方形の和は、初期化の流れと逆の考え方で求められる。
  - すなわち、「足しすぎた分を引く」のではなく、「引きすぎた分を足す」。
  - `(原点と右下の座標がなす長方形) - (左端の左の長方形) - (上端の上の長方形) + (左端上端の左上の座標と原点がなす長方形)`
  - よって、定数オーダーで求められる。

## imos法

区間の足し合わせを高速で行うことができる。

ナイーブな手法だと愚直に塗りつぶす必要があるため `O(区間の数*領域の数)` となるが、各区間に対して塗りつぶしを一気に同時に行うことで `O(区間の数+領域の数)` とできる。

### 1次元

- 区間の始まりで `+1` を、区間の終わりで `-1` を記録しておく。
- 塗りつぶし時に直前の値を現在の値に加算する。
  - ほとんどの部分が0であるため、それまでの累積和が加算される（単純に塗りつぶされていく）。

**`-1` を打つ場所に注意！（2次元の場合が理解しやすくなる）**

### 2次元

- 区間（矩形）の始まりを「左上」とする。
- 左上に `+1`、右上・左下に `-1` 、右下に `+1` を打つ。
  - **右上・左下・右下の3つは矩形外であることに注意！**
- 各行について横方向の累積和をとった後、各列について縦方向の累積和を取る。

一見すると、これでちゃんと所望の累積和が求められるが不思議な気がするが、
**左上の `+1` は矩形の塗りつぶしを担う起点、右上・左下の `-1` は矩形の伝搬を打ち消すためのもの、右下の `+1` は負の伝搬を終わらせるためのもの** 、
と考えると理解しやすいかもしれない。
